generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model VisitorFingerprint {
  id          Int      @id @default(autoincrement())
  hash        String   @unique
  serverToken String   @unique
  visits      Int      @default(1)
  firstSeen   DateTime @default(now())
  lastSeen    DateTime @updatedAt
  userAgent   String?
  ip          String?
  meta        Json?

  // Relations
  progress VisitorAchievement[] @relation("VisitorToAchievement")
  events   EventLog[]           @relation("VisitorToEventLog")
  stats    VisitorStats?

  @@index([hash])
  @@index([serverToken])
}

model VisitorAchievement {
  id             Int       @id @default(autoincrement())
  visitorId      Int
  achievementId  Int
  unlockedAt     DateTime?
  progressNumber Int       @default(0)
  lastProgressAt DateTime?

  // Relations (must mirror the parent side)
  visitor     VisitorFingerprint @relation("VisitorToAchievement", fields: [visitorId], references: [id], onUpdate: Cascade, onDelete: Cascade, map: "fk_visitorachievement_visitor")
  achievement Achievement        @relation("AchievementToVisitor", fields: [achievementId], references: [id], onUpdate: Cascade, onDelete: Cascade, map: "fk_visitorachievement_achievement")

  @@unique([visitorId, achievementId])
}

model EventLog {
  id        Int       @id @default(autoincrement())
  visitorId Int
  type      EventType
  valueNum  Float?
  meta      Json?
  createdAt DateTime  @default(now())

  visitor VisitorFingerprint @relation("VisitorToEventLog", fields: [visitorId], references: [id], onUpdate: Cascade, onDelete: Cascade, map: "fk_eventlog_visitor")

  @@index([visitorId, type, createdAt])
}

model VisitorStats {
  visitorId      Int   @id
  visits         Int   @default(0)
  pagesSeen      Int   @default(0)
  totalTimeSec   Int   @default(0)
  maxScrollDepth Float @default(0)
  contactSubmits Int   @default(0)
  shares         Int   @default(0)

  visitor VisitorFingerprint @relation(fields: [visitorId], references: [id], onUpdate: Cascade, onDelete: Cascade, map: "fk_visitorstats_visitor")
}

enum EventType {
  VISIT
  PAGE_VIEW
  TIME_SPENT_SEC
  SCROLL_DEPTH
  CONTACT_SUBMIT
  SHARE
}

model Achievement {
  id          Int     @id @default(autoincrement())
  slug        String  @unique
  title       String
  description String
  icon        String?
  goalNumber  Int?

  // Relation mirror
  progress VisitorAchievement[] @relation("AchievementToVisitor")
}
